## TCP/IP

### TCP/IP??

- Transmission Control Protocol / Internet Protocol
- 네트워크 통신을 가능하게 해주는 표준 프로토콜 스택(4계층)
- 데이터 분할, 전송, 라우팅, 복구 등 모든 과정 관리

### 특징

1. 계층구조: 4계층 모델로 동작, 독립적 설계와 관리
2. 표준화: 전 세계 표준으로 다양한 환경에서 호환성
3. 유연성: 네트워크 크기 관계 없이 작동
4. 신뢰성: 데이터 손실 방지 및 복구 메커니즘 제공

### 계층구조

- 네트워크 액세스(링크)
- 인터넷
- 전송(Transport)
- 애플리케이션

### 계층 구성의 이유

1. 역할분담
    1. 각 계층이 특정 기능만 집중적으로 처리하도록 설계
    2. 전송 계층의 데이터 신뢰성 보장, 인터넷 계층의 데이터 전달
2. 유연성
    1. 새로운 프로토콜 추가/수정 시 다른 계층에 영향 없음
    2. 계층 간 인터페이스가 명확히 정의됨
3. 효율성
    1. 하드웨어, 소프트웨어 모두 계층 구조를 따름
    2. 네트워크 장치 한 호환성 뛰어남

### 네트워크에서의 캡슐화

- 송신자-수신자 데이터 통신 시 각 계층을 지나며 특정 헤더가 붙여지는 과정
- 비캡슐화는 이 과정이 역순으로 진행됨

## PDU

Protocol Data Unit

TCP/IP 각 계층의 데이터 단위

- 애플리케이션 계층: 메세지
- 전송 계층:
    - 세그먼트(TCP): 적절한 크기로 쪼갠 조각
    - 데이터그램(UDP): 세그먼트와 같은 의미
- 인터넷 계층:
    - 패킷: 세그먼트에 SP와 DP가 포함된 IP 헤더가 붙은 형태의 조각
    - SP: 송신자의 32비트 IP 주소
    - DP: 수신자의 32비트 IP 주소
- 네트워크 액세스(링크) 계층:
    - 프레임(데이터 링크 계층): MAC 주소 헤더와 CRC/체크섬 트레일러가 붙은 조각
    - 비트(물리 계층)

## CRC/체크섬 트레일러

Cyclic Redundancy Check / Checksum

- 데이터 통신에서 데이터 무결성을 확인하기 위한 기술
- Trailer라는 형태로 데이터 프레임의 끝에 추가됨
- 간결한 구조로 전송 중 데이터 손상여부 확인할 수 있음

### CRC

- 데이터 프레임 끝에 붙는 트레일러
- 송신자가 데이터를 특정 다항식(Polynomial) 기반 연산으로 생성한 값
- 나눗셈으로 나머지를 계산, 나머지를 데이터 끝에 추가
- 수신자가 동일한 다항식으로 계산, 0이면 오류 없음

### 체크섬

- 데이터를 여러 블록으로 나누고, 각 값을 합산하여 생성한 값
- 송신자가 덧셈한 값을 데이터 끝에 추가
- 수신자가 동일한 덧셈 후 결과 비교

## OSI 7계층

Open Systems Interconnection Model

- 애플리케이션을 3개 레이어
    - Application
    - Presentation
    - Session
- 네트워크 액세스(링크) 계층을 2개 레이어
    - Data-Link
    - Physical
- 나눠서 표현함

## MTU, MSS, PMTUD

패킷을 분할할 수 없어 특정 라우터나 장치의 MTU를 초과하면 데이터 전달이 아예 이루어지지 않을 수 있음

### **MTU (Maximum Transmission Unit)**

- 네트워크 장치가 한 번에 전송할 수 있는 최대 데이터 크기(바이트 단위)

특징

- MTU 크기에는 IP 헤더와 프로토콜 헤더(예: TCP/UDP)가 포함됨
- MTU를 초과하는 데이터는 네트워크 계층에서 **패킷 분할(Fragmentation)** 되어 전송
- **표준 MTU 크기**: 이더넷의 경우 일반적으로 1500바이트
- **문제점**: 패킷 분할은 네트워크 성능 저하와 오류 발생 가능성을 높임
- *e.g.* MTU가 1500바이트인 경우, IP 헤더(20바이트)와 TCP 헤더(20바이트) 제외 최대 1460바이트 데이터 전송 가능

### **MSS (Maximum Segment Size)**

- TCP 계층에서 하나의 세그먼트에 포함할 수 있는 최대 데이터 크기
- MSS = MTU - IP 헤더 크기 - TCP 헤더 크기
- *e.g.* MTU가 1500바이트인 경우 MSS는 1460바이트(1500 - 20 - 20)

**특징**

- MSS는 TCP 연결 설정 시 **SYN 패킷**에서 협상(Negotiation)됨
- 데이터 분할(Fragmentation)을 최소화하여 효율적 전송 가능

### **PMTUD (Path MTU Discovery)**

송신자가 네트워크 경로에서 지원하는 가장 작은 MTU(=Path MTU)를 동적으로 탐색하는 기법

**작동 방식**

1. 송신자가 큰 MTU 크기로 패킷 전송
2. 경로dml 중간 장치에서 MTU 제한을 초과한 경우
**ICMP** “Fragmentation Needed” 메시지를 송신자에게 반환
3. 송신자는 패킷 크기를 줄이고 다시 전송

**장점**

- 불필요한 패킷 분할을 방지하여 효율적인 데이터 전송
- 전체 네트워크 성능 향상

**문제점**

- 일부 네트워크에서는 보안 이유로 ICMP 메시지를 차단, PMTUD 작동에 실패
- 이를 해결하기 위해 “플랫폼 독립적 PMTUD” 같은 대체 기법도 사용

### **MTU, MSS, PMTUD의 관계**

1. **MTU**: 패킷 크기의 물리적 상한선. 모든 데이터와 헤더 포함.
2. **MSS**: TCP 데이터 페이로드 크기의 상한선. MTU에서 IP 및 TCP 헤더 크기를 제외한 값.
3. **PMTUD**: MTU를 초과하는 데이터가 분할되지 않도록 경로에서 가장 작은 MTU를 찾아 송신자가 최적화된 크기로 패킷을 전송하도록 도움.

### **중요성**

**MTU와 MSS 조정**: 네트워크 성능 최적화와 패킷 손실 최소화.

**PMTUD 활용**: MTU 초과로 인한 분할 방지 및 성능 문제 해결.

**테스트 필요**: 잘못된 MTU/MSS 설정은 연결 문제(예: 데이터 손실 또는 느린 응답)로 이어질 수 있음.

### 요약

**MTU**: 네트워크 패킷 크기의 상한선.

**MSS**: TCP 세그먼트 크기의 상한선.

**PMTUD**: 최적의 MTU를 찾는 탐험가.

MTU와 MSS는 고정적인 설정이고, PMTUD는 동적으로 경로를 조정하는 방식

## Application Layer(애플리케이션 계층)

- 사용자와 직접 상호작용
- HTTP, FTP, SMTP, DNS 등
- 사용자와 애플리케이션이 네트워크와 통신하도록 도움
- *e.g.* 웹 브라우저 - 서버 HTTP 통신

※ FTP: 파일 전송용, 21번포트, 데이터 암호화X → 보안취약

※ SMTP: Simple Mail Transfer Protocol

### HTTP

- 웹 브라우저와 서버 간 통신을 위한 프로토콜
- HTML를 주고받기 위함
- 헤더를 통한 확장이 쉬움
- Stateless: 요청과 응답이 독립적이고, 이전 요청에 대한 정보를 저장하지 않음

### SSH

- 네트워크 상에서 안전하게 원격 접속을 제공하는 프로토콜
- 데이터 암호화 및 사용자 인증(공개 키/비밀 키 방식) 지원
- 터미널(CLI)을 통해 원격 서버에 명령어를 실행하거나 파일을 전송할 때 사용

### FTP

- 네트워크를 통해 파일을 전송하기 위한 프로토콜
- 기본 FTP는 암호화되지 않아 보안에 취약함
- FTPS, SFTP사용으로 보완

### SMTP

- 메일 전송을 위한 표준 프로토콜

## Transport Layer(전송 계층)

### **TCP (Transmission Control Protocol)**

- **신뢰성이 높은 데이터 전송**을 보장하는 프로토콜
- 인터넷에서 가장 널리 사용됨
- 데이터를 정확하고 순서대로 전달하도록 설계됨

**특징**

1. **연결 기반 (Connection-oriented)**
    1. 데이터 전송 전, **3-way handshake**로 송신자와 수신자 간 연결을 설정
    2. 통신 종료 시 **4-way handshake**로 연결 종료
2. **신뢰성**
    1. 패킷 손실 시 재전송 요청 (ACK/NACK 사용)
    2. 데이터 순서를 보장하며 중복 데이터 제거
3. **흐름 제어 및 혼잡 제어**
    1. 송신 속도를 조정해 네트워크 과부하를 방지.
4. **애플리케이션 사례**
    1. 웹 브라우징(HTTP/HTTPS), 이메일 전송(SMTP), 파일 전송(FTP).

**장단점**

- **장점**: 신뢰성, 데이터 순서 보장.
- **단점**: 연결 설정, 흐름 제어로 인해 속도가 느림.

### **UDP (User Datagram Protocol)**

- **비연결형 통신** 프로토콜
- 빠른 데이터 전송을 우선시하며 신뢰성을 보장하지 않음

**특징**

1. **비연결형 (Connectionless)**
    1. 데이터 전송 전 연결 설정 과정이 없음.
2. **속도 우선**
    1. 오류 복구, 순서 보장 등의 절차를 생략해 전송 속도가 빠름.
3. **신뢰성 부족**
    1. 패킷 손실, 중복, 순서 왜곡이 발생할 수 있음.
4. **애플리케이션 사례**
    1. 실시간 스트리밍(Video, Voice), 온라인 게임, DNS, DHCP.

**장단점**

- **장점**: 빠른 전송 속도, 네트워크 리소스 절약.
- **단점**: 신뢰성, 데이터 순서 보장 없음.

### **TCP와 UDP 비교**

|  | TCP | UDP |
| --- | --- | --- |
| 연결 방식 | 연결 기반 (Connection-oriented) | 비연결형 (Connectionless) |
| 신뢰성 | 데이터 순서 보장, 손실 시 재전송 | 신뢰성 보장 안 함 |
| 속도 | 느림 | 빠름 |
| 사용 사례 | 웹, 이메일, 파일 전송 | 스트리밍, 게임, DNS |
| 헤더 크기 | 20~60 바이트 | 8 바이트 |

### **TCP와 UDP 활용 예시**

- **TCP**
    - **HTTP/HTTPS**: 웹사이트 접속
    - **SMTP**: 이메일 전송
    - **FTP**: 파일 전송
    - **SSH**: 원격 접속 및 보안 통신
- **UDP**
    - **DNS**: 도메인 이름 해석
    - **VoIP**: 인터넷 전화
    - **온라인 게임**: 빠른 데이터 전
    - **스트리밍**: 비디오, 음악 서비스

TCP는 신뢰성을, UDP는 속도를 중점적으로 사용

## Internet Layer(인터넷 계층)

- 네트워크 상에서 **데이터를 목적지까지 전달**하는 데 중점을 둔 계층
- **IP 프로토콜**을 중심으로 동작
- **경로 설정**(Routing)과 **패킷 전달**(Packet Forwarding)을 담당

### **주요 역할**

1. **패킷 주소 지정 (Addressing)**
    1. 데이터를 전송할 대상과 출발지의 IP 주소를 설정
    2. 각 장치를 식별하기 위해 고유한 **IP 주소**를 사용
2. **라우팅 (Routing)**
    1. 목적지까지의 최적 경로를 결정하고, 중간 경로를 통해 데이터를 전달
3. **패킷 분할 및 재조립 (Fragmentation & Reassembly)**
    1. 데이터가 네트워크의 최대 전송 단위(MTU)를 초과하면 데이터를 작은 패킷으로 분할
    2. 수신 측에서 이를 재조립
4. **데이터 전달 책임 없음 (Best-Effort Delivery)**
    1. 신뢰성을 보장하지 않으며, 패킷 손실, 중복, 순서 왜곡 가능
    2. 신뢰성은 상위 계층(TCP 등)이 처리

### **주요 프로토콜**

1. **IP (Internet Protocol)**
    1. 데이터 전송을 위한 주소 체계와 패킷 전달을 정의
    2. **IPv4**: 32비트 주소 체계 (약 43억 개 주소 가능)
    3. **IPv6**: 128비트 주소 체계 (거의 무한대 주소 가능)
2. **ICMP (Internet Control Message Protocol)**
    1. 네트워크 진단 및 오류 보고에 사용
    2. *e.g.* **ping**, **traceroute**
3. **ARP (Address Resolution Protocol)**
    1. IP 주소를 물리적 주소(MAC)로 변환
4. **RARP (Reverse ARP)**
    1. 물리적 주소(MAC)를 IP 주소로 변환
    2. 현재는 주로 **DHCP**로 대체됨
5. **IPSec (Internet Protocol Security)**
    1. IP 계층에서 보안을 제공하는 프로토콜
    2. 데이터 암호화와 인증을 제공

### **동작 흐름**

1. 송신 측에서 상위 계층(TCP, UDP)에서 전달받은 데이터를 **패킷**으로 분할
2. 패킷에 **IP 주소**를 포함한 헤더를 추가
3. 패킷을 라우터를 통해 목적지로 전달
4. 수신 측에서 패킷을 다시 조립해 상위 계층으로 전달

### **특징**

- **경로 선택**과 **데이터 전달**을 중점적으로 수행
- 데이터의 신뢰성, 순서 보장, 복구는 처리하지 않음
- 효율성과 확장성을 위해 설계됨

### **장단점**

- **장점**: 간단한 설계, 확장성, 라우팅 기능 제공
- **단점**: 신뢰성과 데이터 순서를 보장하지 않음 (Best-Effort)
- 서버는 응답 데이터를 패킷으로 나누어 IP 계층을 통해 클라이언트에 전송
- 인터넷 계층은 **효율적이고 확장 가능한 데이터 전송**을 가능하게 하는 기반 역할

## TCP의 연결 성립, 3-Way Handshake

**TCP**는 신뢰성 있는 데이터 전송을 보장하기 위해 연결을 성립할 때 **3-Way Handshake** 과정을 거침

클라이언트와 서버가 서로 통신 준비가 되었음을 확인하고 연결을 설정하기 위한 과정

### 과정

1. **SYN (Synchronize)**
    1. 클라이언트가 서버에 연결 요청을 보냄
    2. SYN 플래그를 포함한 패킷을 전송하고, 시퀀스 번호 ISN(Client)를 설정
    3. **SYN_SENT**
2. **SYN-ACK (Synchronize-Acknowledge)**
    1. 서버가 연결 요청을 수락하고 클라이언트에게 응답
    2. SYN 플래그와 함께 ACK 플래그를 설정하며, 클라이언트의 ISN + 1을 ACK 번호로 전송
    3. **SYN_RECEIVED**
3. **ACK (Acknowledge)**
    1. 클라이언트가 서버의 응답을 확인하고 연결을 완료한다
    2. ACK 플래그를 설정하며, 서버의 ISN + 1을 ACK 번호로 전송
    3. **ESTABLISHED**

### 요약

1. 클라이언트 → 서버: SYN, ISN(Client)
2. 서버 → 클라이언트: SYN, ACK, ISN(Server)
3. 클라이언트 → 서버: ACK, ISN(Server) + 1

## TCP의 연결 해제, 4-Way Handshake, TIME_WAIT

TCP 연결을 종료할 때는 **4-Way Handshake** 과정을 사용

클라이언트와 서버가 서로 연결을 종료하고, 남아있는 데이터가 안전하게 전달되었음을 보장하기 위한 과정

### **과정**

1. **FIN (Finish)**
    1. 클라이언트가 연결 종료 요청을 보냄
    2. FIN 플래그를 설정하며, 상태를 **FIN_WAIT_1**로 변경
2. **ACK (Acknowledge)**
    1. 서버가 클라이언트의 FIN 요청을 수락하고 ACK를 보냄
    2. 상태를 **CLOSE_WAIT**로 변경
3. **FIN (Finish)**
    1. 서버가 연결 종료 요청을 보냄
    2. 상태를 **LAST_ACK**로 변경
4. **ACK (Acknowledge)**
    1. 클라이언트가 서버의 FIN 요청을 수락하고 ACK를 보냄
    2. 상태를 **TIME_WAIT**로 변경한 후 일정 시간 대기 후 연결 종료

### **정리**

1. 클라이언트 → 서버: FIN
2. 서버 → 클라이언트: ACK
3. 서버 → 클라이언트: FIN
4. 클라이언트 → 서버: ACK

### **TIME_WAIT**

연결 종료 후 일정 시간 동안 소켓을 유지하는 상태

- **지연된 패킷 처리**
    - 네트워크에 남아 있을 수 있는 지연된 패킷이 잘못된 연결에 영향을 미치지 않도록 방지
- **포트 재사용 방지**
- 동일한 소켓 주소(IP, 포트 쌍)를 빠르게 재사용하지 않도록 보호
- 기본적으로 **2배의 최대 세그먼트 수명(MSL)** 동안 대기, 보통 1~4분

## **3-Way Handshake와 4-Way Handshake의 차이**

- **3-Way Handshake**는 **양방향 데이터 전송 준비**를 확인하기 위해 3단계로 진행
- **4-Way Handshake**는 **각 방향의 데이터 전송 종료를 독립적으로 처리**하기 위해 4단계로 진행

### **예시**

1. 웹 브라우저가 서버에 접속 시 **3-Way Handshake**로 연결 설정
2. 데이터 전송 후 연결을 끊을 때 **4-Way Handshake**로 종료

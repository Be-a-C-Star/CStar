### L7 스위치(로드 밸런서)

- 로드밸런서라고도 하며, 서버의 부하를 분산하는 기기임
- 서버이중화, 보안에 강점이 있는 장치임
- IP, Port뿐만이 아니라 url, 헤더, 쿠키 등을 기반으로 트래픽을 분산함
- 헬스체크를 통해 장애가 발생한 서버를 확인하고 해당 서버로 트래픽을 보내지 못하게 하는 역할을 함
  ![alt text](<스크린샷 2025-02-11 오전 11.16.02.png>)

#### 헬스 체크

- L4 스위치 또는 L7 스위치 모두 헬스 체크를 통해 정상적인 서버 또는 비정상적인 서버를 판별하는데, 헬스 체크는 전송 주기와 재전송 횟수 등을 설정한 이후 반복적으로 서버에 요청을 보내는 것임
- AWS에서 L7스위치를 이용한 로드 밸런싱은 ALB라는 컴포넌트를 통해서 하며 L4스위치를 이용한 로드 밸런싱은 NLB 컴포넌트를 통해서 구축함

#### 헬스 체크 프로세스

- L7 스위치(로드 밸런서)는 보통 헬스체크용 엔드포인트(예: /health, /status 등)를 미리 설정함.

```
GET /health HTTP/1.1
Host: example.com
```

- 일정 주기(5초, 10초 등)로 서버(백엔드)에게 HTTP 요청을 보내어 위와 같은 식으로 정상적인 HTTP 패킷을 전송함
- 만약 서버가 정상 동작하면, 200번대 응답 혹은 사전에 약속된 형태의 콘텐츠(Ex. `{"status": "ok"}`)를 돌려줌
  - 서버가 다운되거나, CPU가 바쁘거나, 정상적인 HTTP 헤더를 반환하지 못하면, 로드 밸런서는 타임아웃이나 4xx/5xx 등을 받음
- L7 스위치는 응답 코드, 응답 바디, 지연 시간 등을 기준으로 서버의 상태를 판별함
  - 성공 조건: 상태코드가 200~399 범위 내인지, 혹은 특정 문자열이 바디에 포함되어 있는지 등
  - 실패 조건: 타임아웃, 4XX/5XX 응답, 특정 문자열 불일치 등
  - 헬스체크가 실패로 간주되면, 로드 밸런서는 해당 서버를 일시적으로 `Unhealthy` 상태로 표시하고, 새 요청을 보내지 않음
- 일회성 실패만으로 서버를 바로 빼지 않는 경우가 많음
  - Ex. 3번 연속 헬스체크가 실패하면 Unhealthy로 간주, 2번 연속 성공하면 다시 Healthy 복귀 등 정해진 임계치를 넘어야 상태 변경이 일어남
- 헬스체크 결과에 따라 `Healthy` 서버만 트래픽을 전달받음. `Unhealthy` 서버는 더 이상 요청을 할당받지 않다가, 이후 헬스체크가 다시 성공해 정상 상태로 회복되면 다시 트래픽을 분산함

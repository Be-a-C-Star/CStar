# 웹 브라우저의 캐시

## 로컬 스토리지

- `{ key : value }` 형태의 웹 스토리지 객체
- 최대 5MB 저장
- 각 브라우저마다 저장이 되는 데이터
- 하나의 키에 하나의 값만 저장된다
- 만료일이 없어서 사용자가 직접 삭제하지 않으면 평생 로컬 저장소에 저장된다 (종료해도 사라지지 않음)
- 사용자의 행위를 기억(조건 필터링 등)하거나 로그인을 유지하기 위한 값으로 사용
- 쿠키와 달리 데이터가 자동으로 서버에 전송되지 않는다

### 사용법

- 설정 : `localStorage.setItem(key, value);`
- key에 해당하는 value 가져오기 : `localStorage.getItem(key);`
- 제거 : `localStorage.removeItem(key);`
- 전체제거 : `localStorage.clear();`

### 오리진

- 같은 브라우저 내에서 공유
- 로컬스토리지 데이터는 오리집에 종속된다
- URL의 프로토콜, 호스트명, 포트번호까지 오리진이라 뜻한다

## 세션 스토리지

- `{ key : value }` 형태로 오리진에 종속되어 저장되는 데이터
- 최대 5MB 저장
- 하나의 키에 하나의 값만 저장된다
- 브라우저의 각 탭마다 독립적으로 저장
- 사용자가 탭을 닫으면 데이터는 만료된다
- 보통 세션 스토리지보단 로컬 스토리지를 많이 사용한다

### 사용법

- 설정 : `sessionStorage.setItem(key, value);`
- 탐색 : `sessionStorage.getItem(key);`
- 제거 : `sessionStorage.removeItem(key);`
- 전체제거 : `sessionStorage.clear();`

## 쿠키(Cookie)

- 브라우저에 저장된 데이터 조각
- 클라이언트/서버 둘 다 설정 및 조작 가능
    - 보통은 서버에서 만료기한 등을 설정하고 컨트롤한다
- 서버의 응답 헤더에 `Set-Cookie`로 설정해서 응답하면 클라이언트의 요청 헤더 Cookie에 설정되어 자동으로 서버에 전달되고 브라우저에도 저장된다.
- 최대 4KB까지 가능
- 로그인, 장바구니, 사용자 커스터마이징 등에 사용된다

#### 클라이언트에서 설정 가능한 쿠키

```js
axios.get(url, { 
    headers: {
                Cookie: "cookie1=value; cookie2=value; cookie3=value;"
            }
}).then
```

클라이언트에서 `document.cookie`를 통해 쿠키를 설정하거나 요청할 때 `header-Cookie` 값을 정해서 보낼 수도 있다. 하지만 쿠키에는 보통 민감한 정보들이 담기기 때문에 쿠키에 대한 제어권은 클라이언트가 아닌 서버가 가지고 있는 것이 좋다.

#### 세션 쿠키

Expires 또는 Max-Age 속성을 지정하지 않은 쿠키를 말한다. 브라우저가 종료되면 쿠키도 사라진다.

#### 영구 쿠키

Expires 또는 Max-Age 속성을 지정해서 특정 날짜 또는 일정 기간이 지나면 삭제되게 만든 쿠키이다. 브라우저를 닫아도 만료되지 않는다.

### 옵션

- secure
    - https로만 쿠키를 주고받을 수 있는 옵션
    - Chrome v89, Firefox v75 이상부터 localhost에서는 무시된다
- httponly
    - 공격자가 쿠키를 자바스크립트로 빼낼 수 없게 한다
    - `document.cookie`로 접근 불가
- samesite
    - 요청이 동일한 도메인에서 시작된 경우만 쿠키가 전송되도록 허용

### 시큐어코딩

쿠키 - 세션으로 로그인 기능을 만들면 아래와 같은 시큐어 코딩을 해야한다.

1. cookie에 세션ID를 담을 때, 해당 세션 ID기반으로 개인정보를 유추할 수 없어야 한다.
2. httponly, secure 옵션을 걸어야 한다.
3. 일정 시간의 세션 타임아웃을 걸어야 한다.

### 쿠키 허용 관련 알림창

서비스 운용시 쿠키를 사용한다면 허용관련 알림창이 필요하다. 방문 기록을 추척할 때 쿠키가 사용되기 때문인데, 이는 사용자의 데이터 간접수집에 해당하며 KISA 지침을 준수하기 위함이다.

```text
정보보호 및 개인정보보호 관리체계(ISMS-P) 인증기준(KISA) 2019.01 3.1.5 간접수집 보호조치

정보주체(이용자) 이외로부터 개인정보를 수집하거나 제공받는 경우에는 업무에 필요한 최소한의 개인정보만 수집 . 이용하여야 하고 법령에 근거하거나 정보주체(이용자)의요구가 있으면 개인정보의 수집 출처, 처리목적, 처리정지의 요구권리를 알려야 한다.
서비스 계약 이행을 위해 필요한 경우로서 사업자가 서비스 제공과정에서 자동수집장치 등에 의해 수집 . 생성되는 개인정보(통화기록, 접속로그, 결제기록, 이용내역 등)에 대해서도, 해당 서비스의 계약 이행 및 제공을 위해 필요한 최소한의 개인정보만을 수집하여야 한다.

▶ 다만, 서비스 제공 계약 이행과는 무관한 목적으로 이용하기 위해 수집하는 경우에는 선택 동의 항목으로 분류하여 별도의 사전 동의를 받아야 함 (예를 들어, 쿠키를 통해
수집하는 행태정보를 분석하여 개인별 맞춤형 광고에 활용하는 경우 등)
```

### 공통점

1. 브라우저에 캐싱함으로 서버 요청을 줄여 서버 부하를 방지한다.
2. 캐싱으로 인해 다운로드하는 컨텐츠가 줄어든다.
3. 사이트 커스터마이징이나 로그인 상태를 유지할 때 사용한다

### 차이점 

| | 쿠키 | 로컬 스토리지 | 세션 스토리지|
| :--: | :--: | :--: | :--: |
| 최대저장용량 | 4KB | 5MB | 5MB |
| 브라우저 허용 | HTML4 + 5 | HTML 5 | HTML 5 |
| 접근 범위 | 오리진 | 오리진 | 탭 |
| 만료 기한 | 수동 설정 | 영구적 | 탭 닫으면 소멸 |
| 주체 | 클라이언트 + 서버 | 클라이언트 | 클라이언트 |
| 요청 시 자동 전송 | O | X | X |

쿠키와 로컬 스토리지는 오리진이 같은 여러개의 창이나 탭을 닫아도 유지가 된다.